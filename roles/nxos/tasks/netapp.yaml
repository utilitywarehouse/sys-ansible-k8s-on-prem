- name: Ensure netapp interfaces are Layer 2 ports and set the proper description
  nxos_interface:
    name: "{{ item }}"
    description: "Netapp"
    mode: layer2
  loop: "{{ netapp_port_list }}"
  tags:
  - netapp

- name: Configure trunk interfaces for vlan "{{ vlan_netapp_id }}"
  nxos_l2_interface:
    interface: "{{ item }}"
    mode: trunk
    trunk_allowed_vlans: "{{ vlan_netapp_id }}"
  loop: "{{ netapp_port_list }}"
  tags:
  - netapp

- name: Ensure VLAN {{ vlan_netapp_id }} exists on the device
  nxos_vlan:
    vlan_id: "{{ vlan_netapp_id }}"
    name: "{{ vlan_netapp_name }}"
    state: present
  tags:
  - netapp

- name: Ensure VLAN {{ vlan_netapp_id }} is up and active
  nxos_vlan:
    vlan_id: "{{ vlan_netapp_id }}"
    name: "{{ vlan_netapp_name }}"
    admin_state: up
    vlan_state: active
  tags:
  - netapp

- name: Create interface SVI {{ vlan_netapp_id }}
  nxos_interface:
    name: "vlan{{ vlan_netapp_name }}"
    admin_state: up
    state: present
  tags:
  - netapp

- name: Ensure vlan {{ vlan_netapp_id }} exist on the vrf
  nxos_vrf_interface:
    vrf: "{{ env_vrf }}"
    interface: "{{ vlan_netapp_name }}"
    state: present
  tags:
  - netapp

- name: Set interface IPv4 address for "{{ vlan_netapp_id }}"
  nxos_l3_interface:
    name: "{{ vlan_netapp_name }}"
    ipv4: "{{ vlan_netapp_ipv4 }}"
    state: present
  tags:
  - netapp

# Routing
- name: Create an acl for the netapp and kubernetes private network
  nxos_acl:
    name: "{{ netapp_acl_name }}"
    seq: 5 # Has to be lower than kube outgoing traffic acl
    action: permit
    proto: ip
    src: "{{ kube_vlan_ip_address }}/{{ kube_vlan_ip_netmask }}"
    dest: "{{ vlan_netapp_ipv4 }}"
    state: present
  tags:
  - kubernetes
  - netapp
  - routing

- name: Create route map for netapp traffic initiated from kubernetes nodes
  nxos_config:
    lines:
      - match ip address {{ netapp_acl_name }}
    parents:
      - route-map {{ kube_private_route_map }} permit 5
  when: not ansible_check_mode
  tags:
  - kubernetes
  - netapp
  - routing
